{% for post in site.posts %}
    {% capture cur_year %} {{post.date | date: "%Y"}} {% endcapture %}
    {% capture cur_month %} {{post.date | date: "%B"}} {% endcapture %}
    {% capture next_year %} {{post.previous.date | date: "%Y"}} {% endcapture %}
    {% capture next_month %} {{post.previous.date | date: "%B"}} {% endcapture %}

    {% if forloop.first %}
        <h4>{{cur_year}}</h4>
        <h5>{{cur_month}}</h5>
        <ul>
    {% endif %}

            <li><a href="{{post.url}}">{{post.title}}</a></li>
    {% if forloop.last %}
        </ul>
    {%else%}
        {% if cur_year != next_year %}
            </ul>
            <h4>{{next_year}}</h4>
            <h5>{{next_month}}</h5>
            <ul>
        {% else %}
                {% if cur_month != next_month %}
                    </ul>
                        <h5>{{next_month}}</h5>
                    <ul>
                {% endif %}
        {% endif %}
    {% endif %}
{% endfor %}